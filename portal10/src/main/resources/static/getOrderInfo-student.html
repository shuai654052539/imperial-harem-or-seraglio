<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=9; IE=8; IE=7; IE=EDGE">
  <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
  <title>结算页</title>
  <link href="/commons/jq/bootstrap3.3.7/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="/js/shop/css/webbase.css"/>
  <link rel="stylesheet" type="text/css" href="/js/shop/css/pages-getOrderInfo.css"/>
</head>

<body>
<!--head-->
<div id="daoHangDiv"></div>
<!--主要信息-->
<div id="directInfo">
  <div class="cart py-container">
    <!--logoArea-->
    <div class="checkout py-container">
      <div class="checkout-tit">
        <h4 class="tit-txt">填写并核对订单信息</h4>
      </div>
      <div class="checkout-steps">
        <!--收件人信息-->
        <div class="step-tit">
          <h5>收件人信息<span><a onclick="add()" data-target=".edit" data-keyboard="false" class="newadd">新增收货地址</a></span>
          </h5>
        </div>
        <div class="step-cont">
          <div class="addressInfo">
            <ul class="addr-detail">
              <li class="addr-item" id="shippingAddress">


                <div class="con name "><a href="javascript:;" value="1" id="recipientInfo">王希<span title="点击取消选择">&nbsp;</a>
                </div>
                <div class="con address">王希 北京市海淀区三环内 中关村软件园6号楼 <span>156****5681</span>
                  <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false"
                                            onclick="add()">编辑</a>&nbsp;&nbsp;<a href="javascript:;">删除</a></span>
                </div>
                <div class="clearfix"></div>

              </li>

            </ul>
            <!--添加地址-->
            <!--<div  tabindex="-1" role="dialog" data-hasfoot="false" class="sui-modal hide fade edit">
              <div class="modal-dialog">
                <div class="modal-content">
                  <div class="modal-header">
                    <button type="button" data-dismiss="modal" aria-hidden="true" class="sui-close">×</button>
                    <h4 id="myModalLabel" class="modal-title">添加收货地址</h4>
                  </div>
                  <div class="modal-body">

                    &lt;!&ndash;<form action="" class="sui-form form-horizontal">
                      <div class="control-group">
                        <label class="control-label">收货人：</label>
                        <div class="controls">
                          <input type="text" class="input-medium">
                        </div>
                      </div>

                      <div class="control-group">
                        <label class="control-label">详细地址：</label>
                        <div class="controls">
                          <input type="text" class="input-large">
                        </div>
                      </div>
                      <div class="control-group">
                        <label class="control-label">联系电话：</label>
                        <div class="controls">
                          <input type="text" class="input-medium">
                        </div>
                      </div>
                      <div class="control-group">
                        <label class="control-label">邮箱：</label>
                        <div class="controls">
                          <input type="text" class="input-medium">
                        </div>
                      </div>
                      <div class="control-group">
                        <label class="control-label">地址别名：</label>
                        <div class="controls">
                          <input type="text" class="input-medium">
                        </div>
                        <div class="othername">
                          建议填写常用地址：<a href="#" class="sui-btn btn-default">家里</a>　<a href="#" class="sui-btn btn-default">父母家</a>　<a href="#" class="sui-btn btn-default">公司</a>
                        </div>
                      </div>

                    </form>&ndash;&gt;


                  </div>
                  <div class="modal-footer">
                    <button type="button" data-ok="modal" class="sui-btn btn-primary btn-large">确定</button>
                    <button type="button" data-dismiss="modal" class="sui-btn btn-default btn-large">取消</button>
                  </div>
                </div>
              </div>
            </div>-->
            <!--确认地址-->
          </div>
          <div class="hr"></div>

        </div>
        <div class="hr"></div>
        <!--支付和送货-->
        <div class="payshipInfo">
          <div class="step-tit">
            <h5>支付方式</h5>
          </div>
          <div class="step-cont">
            <ul class="payType">
              <li class="selected" name="payType" value="1">微信付款<span title="点击取消选择"></span></li>
              <li name="payType" value="2">货到付款<span title="点击取消选择"></span></li>
            </ul>
          </div>
          <div class="hr"></div>
          <div class="step-tit">
            <h5>送货清单</h5>
          </div>
          <div class="step-cont">
            <ul class="send-detail">
              <li>
                <div class="sendGoods" id="cartInfo">
                  <!--购物信息----------------------------->
                </div>
              </li>
              <li></li>
              <li></li>
            </ul>
          </div>
          <div class="hr"></div>
        </div>
        <div class="linkInfo">
          <div class="step-tit">
            <h5>发票信息</h5>
          </div>
          <div class="step-cont">
            <span>普通发票（电子）</span>
            <span>个人</span>
            <span>明细</span>
          </div>
        </div>
        <div class="cardInfo">
          <div class="step-tit">
            <h5>使用优惠/抵用</h5>
          </div>
        </div>
      </div>
    </div>
    <div class="order-summary">
      <!--商品总金额，返现，运费DIV-->
      <div class="static fr" id="summaryInfo">

      </div>
    </div>
    <!--应付金额，送货地址DIV-->
    <div class="clearfix trade" id="tradeInfo">

    </div>
    <div class="submit">
      <a class="sui-btn btn-danger btn-xlarge" onclick="submitOrder()">提交订单</a>
    </div>
  </div>
</div>
<!-- 底部栏位 -->
<!--页面底部-->
<div class="clearfix footer">
  <div class="py-container">
    <div class="footlink">
      <div class="Mod-service">
        <ul class="Mod-Service-list">
          <li class="grid-service-item intro  intro1">

            <i class="serivce-item fl"></i>
            <div class="service-text">
              <h4>正品保障</h4>
              <p>正品保障，提供发票</p>
            </div>

          </li>
          <li class="grid-service-item  intro intro2">

            <i class="serivce-item fl"></i>
            <div class="service-text">
              <h4>正品保障</h4>
              <p>正品保障，提供发票</p>
            </div>

          </li>
          <li class="grid-service-item intro  intro3">

            <i class="serivce-item fl"></i>
            <div class="service-text">
              <h4>正品保障</h4>
              <p>正品保障，提供发票</p>
            </div>

          </li>
          <li class="grid-service-item  intro intro4">

            <i class="serivce-item fl"></i>
            <div class="service-text">
              <h4>正品保障</h4>
              <p>正品保障，提供发票</p>
            </div>

          </li>
          <li class="grid-service-item intro intro5">

            <i class="serivce-item fl"></i>
            <div class="service-text">
              <h4>正品保障</h4>
              <p>正品保障，提供发票</p>
            </div>

          </li>
        </ul>
      </div>
      <div class="clearfix Mod-list">
        <div class="yui3-g">
          <div class="yui3-u-1-6">
            <h4>购物指南</h4>
            <ul class="unstyled">
              <li>购物流程</li>
              <li>会员介绍</li>
              <li>生活旅行/团购</li>
              <li>常见问题</li>
              <li>购物指南</li>
            </ul>

          </div>
          <div class="yui3-u-1-6">
            <h4>配送方式</h4>
            <ul class="unstyled">
              <li>上门自提</li>
              <li>211限时达</li>
              <li>配送服务查询</li>
              <li>配送费收取标准</li>
              <li>海外配送</li>
            </ul>
          </div>
          <div class="yui3-u-1-6">
            <h4>支付方式</h4>
            <ul class="unstyled">
              <li>货到付款</li>
              <li>在线支付</li>
              <li>分期付款</li>
              <li>邮局汇款</li>
              <li>公司转账</li>
            </ul>
          </div>
          <div class="yui3-u-1-6">
            <h4>售后服务</h4>
            <ul class="unstyled">
              <li>售后政策</li>
              <li>价格保护</li>
              <li>退款说明</li>
              <li>返修/退换货</li>
              <li>取消订单</li>
            </ul>
          </div>
          <div class="yui3-u-1-6">
            <h4>特色服务</h4>
            <ul class="unstyled">
              <li>夺宝岛</li>
              <li>DIY装机</li>
              <li>延保服务</li>
              <li>品优购E卡</li>
              <li>品优购通信</li>
            </ul>
          </div>
          <div class="yui3-u-1-6">
            <h4>帮助中心</h4>
            <img src="img/wx_cz.jpg">
          </div>
        </div>
      </div>
      <div class="Mod-copyright">
        <ul class="helpLink">
          <li>关于我们<span class="space"></span></li>
          <li>联系我们<span class="space"></span></li>
          <li>关于我们<span class="space"></span></li>
          <li>商家入驻<span class="space"></span></li>
          <li>营销中心<span class="space"></span></li>
          <li>友情链接<span class="space"></span></li>
          <li>关于我们<span class="space"></span></li>
          <li>营销中心<span class="space"></span></li>
          <li>友情链接<span class="space"></span></li>
          <li>关于我们</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<!--页面底部END-->


<!--模板DIV-->
<div id="cartTemplate" class="hidden">
  <ul class="yui3-g">
    <li class="yui3-u-1-6">
      <span><img src="##img##"/></span>
    </li>
    <li class="yui3-u-7-12">
      <div class="desc">##itmeName##</div>
      <div class="seven">7天无理由退货</div>
    </li>
    <li class="yui3-u-1-12">
      <div class="price">￥##price##</div>
    </li>
    <li class="yui3-u-1-12">
      <div class="num">X##count##</div>
    </li>
    <li class="yui3-u-1-12">
      <div class="exit">有货</div>
    </li>
  </ul>
</div>
<div id="summaryTemplate" class="hidden">
  <div class="list">
    <span><i class="number">##count##</i>件商品，总商品金额</span>
    <em class="allprice">¥##sumTotal##</em>
  </div>
  <div class="list">
    <span>返现：</span>
    <em class="money">0.00</em>
  </div>
  <div class="list">
    <span>运费：</span>
    <em class="transport">0.00</em>
  </div>
</div>
<div id="tradeTemplate" class="hidden">
  <div class="fc-price">应付金额:　<span class="price">¥##sumTotal##</span></div>
  <div class="fc-receiverInfo">寄送至:北京市海淀区三环内 中关村软件园9号楼 收货人：某某某 159****3201</div>
</div>
<div id="addFormTemplate" class="hidden">
  <form class="form-horizontal">
    <div class="form-group">
      <label class="col-md-2 control-label">收件人</label>
      <div class="col-md-4">
        <input type="text" class="form-control" id="recipientName" placeholder="请输入用户名...">
      </div>
    </div>
    <div class="form-group">
      <label class="col-md-2 control-label">手机号码</label>
      <div class="col-md-4">
        <input type="text" class="form-control" id="recipientPhone" placeholder="请输入用户名...">
      </div>
    </div>
    <div class="form-group" id="area">
      <label class="col-md-2 control-label">地址</label>

    </div>
    <input type="hidden" name="areaid1"/>
    <input type="hidden" name="areaid2"/>
    <input type="hidden" name="areaid3"/>
    <div class="form-group">
      <label class="col-md-2 control-label">详细地址</label>
      <div class="col-md-4">
        <input type="text" class="form-control" id="detailedAddress" placeholder="请输入详细地址...">
      </div>
    </div>
  </form>
</div>
<div id="updateFormTemplate" class="hidden">
  <form class="form-horizontal">
    <div class="form-group">
      <label class="col-md-2 control-label">收件人</label>
      <div class="col-md-4">
        <input type="text" class="form-control" id="up_recipientName" placeholder="请输入用户名...">
      </div>
    </div>
    <div class="form-group">
      <label class="col-md-2 control-label">手机号码</label>
      <div class="col-md-4">
        <input type="text" class="form-control" id="up_recipientPhone" placeholder="请输入用户名...">
      </div>
    </div>
    <div class="form-group" id="up_area">
      <label class="col-md-2 control-label">地址</label>

    </div>
    <input type="hidden" name="areaid1"/>
    <input type="hidden" name="areaid2"/>
    <input type="hidden" name="areaid3"/>
    <input type="hidden" id="up_RecipientId"/>
    <input type="hidden" id="up_memberId"/>
    <div class="form-group">
      <label class="col-md-2 control-label">详细地址</label>
      <div class="col-md-4">
        <input type="text" class="form-control" id="up_detailedAddress" placeholder="请输入详细地址...">
      </div>
    </div>
  </form>
</div>
<div id="shippingAddressTemplate" class="hidden">
  <div class="con name" name="recipientName" value="##id##"><a href="javascript:;">##recipientName##<span
      title="点击取消选择">&nbsp;</a></div>
  <div class="con address">##specificAddress## <span>##recipientPhone##</span>
    <span class="edittext"><a data-toggle="modal" data-target=".edit" data-keyboard="false"
                              onclick="updateInfo('##id##')">编辑</a>&nbsp;&nbsp;<a href="javascript:;"
                                                                                  onclick="del('##id##')">删除</a></span>
  </div>
  <div class="clearfix"></div>
</div>

<script type="text/javascript" src="/js/shop/js/plugins/jquery/jquery.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/jquery.easing/jquery.easing.min.js"></script>
<script type="text/javascript" src="/js/shop/js/plugins/sui/sui.min.js"></script>
<script type="text/javascript" src="/js/shop/js/pages/getOrderInfo.js"></script>
<script type="text/javascript" src="/commons/jq/bootstrap3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/jquery.cookie.js"></script>
<script src="/commons/daohangtiao.js"></script>
<script type="text/javascript" src="/commons/jq/bootbox/bootbox.min.js"></script>
<script type="text/javascript" src="/commons/jq/bootbox/bootbox.locales.min.js"></script>
<script>
  var addFormHtml;
  var updateFormHtml;
  $(function() {
    initCart();
    addFormHtml = $('#addFormTemplate').html();
    updateFormHtml = $('#updateFormTemplate').html();
    infoShippingAddress();
  });

  function infoShippingAddress() {
    $.ajax({
      url: 'http://localhost:8083/recipients.jhtml',
      type: 'get',
      success: function(result) {
        if (result.code == 200) {
          var data = result.data;
          var template = $('#shippingAddressTemplate').html();
          var str = '';
          for (var i = 0; i < data.length; i++) {
            var v_data = data[i];
            var v_template = template.replace(/##id##/g, v_data.id)
                .replace('##recipientName##', v_data.recipientName)
                .replace('##specificAddress##', v_data.recipientName + ' ' + v_data.specificAddress + ' ' + v_data.detailedAddress)
                .replace('##recipientPhone##', v_data.recipientPhone);
            str += v_template;
          }
          $('#shippingAddress').html(str);

          $(function() {
            $('.address').hover(function() {
              $(this).addClass('address-hover');
            }, function() {
              $(this).removeClass('address-hover');
            });
          });

          $(function() {
            $('.addr-item .name').click(function() {
              $(this).toggleClass('selected').siblings().removeClass('selected');
            });
            /*$('.payType li').click(function(){
              $(this).toggleClass('selected').siblings().removeClass('selected');
            });*/
          });

          $($('div[name=\'recipientName\']')[0]).attr('class', 'con name selected');
        }
      }
    });
  }

  function del(id) {
    $.ajax({
      url: 'http://localhost:8083/recipients/' + id + '.jhtml',
      type: 'delete',
      success: function(result) {
        if (result.code != 200) {
          alert('删除失败');
        }
        infoShippingAddress();
      }
    });
  }

  function initArea(id, obj) {
    if (obj) {
      $(obj).parent().nextAll().remove();
    }
    $.ajax({
      url: 'http://localhost:8083/areas.jhtml',
      type: 'get',
      data: {id: id},
      success: function(res) {
        if (res.code == 200) {
          if (res.data.length == 0) {
            return;
          }
          var str = '<div class="col-md-3"><select name="genreSelect" class="form-control" onchange="initArea(this.value,this)">' +
              '<option value="-1">===请选择===</option> ';
          for (var i = 0; i < res.data.length; i++) {
            str += '<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>';
          }
          str += '</select><div>';
          $('#area', addinfo).append(str);
        }
      }
    });
  }

  function updateArea(id, obj) {
    if (obj) {
      $(obj).parent().nextAll().remove();
    }
    $.ajax({
      url: 'http://localhost:8083/areas.jhtml',
      type: 'get',
      data: {id: id},
      async: false,
      success: function(res) {
        if (res.code == 200) {
          if (res.data.length == 0) {
            return;
          }
          var str = '<div class="col-md-3"><select name="updateSelect" class="form-control" onchange="updateArea(this.value,this)">' +
              '<option value="-1">===请选择===</option> ';
          for (var i = 0; i < res.data.length; i++) {
            str += '<option value="' + res.data[i].id + '">' + res.data[i].name + '</option>';
          }
          str += '</select><div>';
          $('#up_area', addinfo).append(str);
        }
      }
    });
  }


  var addinfo;
  var updateinfo;

  function add() {
    initArea(0);
    addinfo = bootbox.confirm({
      title: 'Destroy planet?',
      size: 'large',
      backdrop: false,
      message: $('#addFormTemplate form'),
      buttons: {
        confirm: {
          label: 'Yes',
          className: 'btn-success'
        },
        cancel: {
          label: 'No',
          className: 'btn-danger'
        }
      },
      callback: function(result) {
        if (result) {
          var json = {};
          json.recipientName = $('#recipientName').val();
          json.recipientPhone = $('#recipientPhone').val();
          json.detailedAddress = $('#detailedAddress').val();
          json.areaid1 = $($('select[name=\'genreSelect\']')[0]).val();
          json.areaid2 = $($('select[name=\'genreSelect\']')[1]).val();
          json.areaid3 = $($('select[name=\'genreSelect\']')[2]).val();
          $.ajax({
            url: 'http://localhost:8083/recipients.jhtml',
            type: 'post',
            data: json,
            success: function(result) {
              if (result.code == 200) {
                infoShippingAddress();
              }
            }
          });
        }
        $('#addFormTemplate').html(addFormHtml);
      }
    });
  }

  function updateInfo(id) {
    $.ajax({
      url: 'http://localhost:8083/recipients/' + id + '.jhtml',
      type: 'get',
      success: function(result) {
        if (result.code == 200) {
          $('#up_recipientName').val(result.data.recipientName);
          $('#up_recipientPhone').val(result.data.recipientPhone);
          $('#up_detailedAddress').val(result.data.detailedAddress);
          $('#up_RecipientId').val(result.data.id);
          $('#up_memberId').val(result.data.memberId);
          updateArea(0);
          updateArea(result.data.areaid1);
          updateArea(result.data.areaid2);
          $($('select[name=\'updateSelect\']')[0]).val(result.data.areaid1);
          $($('select[name=\'updateSelect\']')[1]).val(result.data.areaid2);
          $($('select[name=\'updateSelect\']')[2]).val(result.data.areaid3);
          updateinfo = bootbox.confirm({
            title: 'Destroy planet?',
            size: 'large',
            backdrop: false,
            message: $('#updateFormTemplate form'),
            buttons: {
              confirm: {
                label: 'Yes',
                className: 'btn-success'
              },
              cancel: {
                label: 'No',
                className: 'btn-danger'
              }
            },
            callback: function(result) {
              if (result) {
                var up_json = {};
                up_json.recipientName = $('#up_recipientName').val();
                up_json.recipientPhone = $('#up_recipientPhone').val();
                up_json.detailedAddress = $('#up_detailedAddress').val();
                up_json.areaid1 = $($('select[name=\'updateSelect\']')[0]).val();
                up_json.areaid2 = $($('select[name=\'updateSelect\']')[1]).val();
                up_json.areaid3 = $($('select[name=\'updateSelect\']')[2]).val();
                up_json.id = $('#up_RecipientId').val();
                up_json.memberId = $('#up_memberId').val();
                $.ajax({
                  url: 'http://localhost:8083/recipients.jhtml',
                  type: 'put',
                  contentType: 'application/json',
                  data: JSON.stringify(up_json),
                  success: function(result) {
                    if (result.code == 200) {
                      infoShippingAddress();
                    }
                  }
                });
              }
              $('#updateFormTemplate').html(updateFormHtml);
            }
          });
        }
      }
    });
  }


  //提交订单
  function submitOrder() {
    var recipientInfo = '';
    $('div[name="recipientName"]').each(function() {
      if ($(this).attr('class') == 'con name selected') {
        recipientInfo = $(this).attr('value');
      }
    });
    alert(recipientInfo);
    var payType = '';
    $('li[name=\'payType\']').each(function() {
      if ($(this).attr('class') == 'selected') {
        payType = $(this).attr('value');
      }
    });
    $.ajax({
      url: 'http://localhost:8083/orders.jhtml',
      data: {payType: payType, recipientInfo: recipientInfo},
      type: 'post',
      beforeSend: function(xhr) {
        var token = $.cookie('token');
        var x_fh = $.cookie('x_fh');
        xhr.setRequestHeader('x_fh', x_fh);
        xhr.setRequestHeader('token', token);
      },
      success: function(result) {
        $.cookie('result', JSON.stringify(result));
        if (result.data && result.data.length > 0) {
          /*JSON字符串装换为对象
          var a=$.cookie("result")
          alert(eval("("+a+")").code)*/
          location.href = '/aaaa.html';
        }
        if (result.code == 200) {
          location.href = '/pay-student.html';

        }
      }
    });
  }

  function initCart() {
    if (!loginFlag) {
      $('#directInfo').html('<h1 style=\'text-align: center\'>要先登录，才能访问</h1>');
    } else {
      $.ajax({
        url: 'http://localhost:8083/carts.jhtml',
        type: 'get',
        success: function(result) {
          if (result.code == 200) {
            var data = result.data.list;
            console.log(data);
            var v_cartBody = $('#cartTemplate').html();
            var str = '';
            for (var i = 0; i < data.length; i++) {
              str += v_cartBody.replace('##img##', data[i].img)
                  .replace('##price##', data[i].price).replace('##count##', data[i].num)
                  .replace('##itmeName##', data[i].itmeName);
            }
            $('#cartInfo').html(str);
            str = $('#summaryTemplate').html().replace('##count##', result.data.count).replace('##sumTotal##', result.data.sumTotal);
            $('#summaryInfo').html(str);
            str = $('#tradeTemplate').html().replace('##sumTotal##', result.data.sumTotal);
            $('#tradeInfo').html(str);
          } else {
            /*$('#cartInfo').html('<h1 style=\'text-align: center\'>我来也，却空空如也</h1>');*/
            location.href = '/cart.html';
          }
        }
      });
    }
  }
</script>
</body>

</html>
